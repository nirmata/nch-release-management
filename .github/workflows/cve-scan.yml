name: CVE Scan

on:
  schedule:
    # Run at 2:00 AM PST (10:00 AM UTC during standard time, 9:00 AM UTC during daylight time)
    # Using 10:00 AM UTC to cover PST standard time
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      release_filter:
        description: 'Specific release to scan (e.g., nch-4.22.11). Leave empty to scan all releases.'
        required: false
        type: string

# Add permissions for accessing packages and writing to repository
permissions:
  contents: write          # For committing scan results
  packages: read           # For accessing private packages in GHCR
  actions: read            # For workflow execution
  id-token: write          # For OIDC token if needed

jobs:
  discover-releases:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ steps.find-releases.outputs.releases }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Find release directories
        id: find-releases
        run: |
          if [ -n "${{ github.event.inputs.release_filter }}" ]; then
            # If a specific release is requested, only scan that one
            if [ -d "cve-management/releases/${{ github.event.inputs.release_filter }}" ]; then
              releases='["${{ github.event.inputs.release_filter }}"]'
            else
              echo "::error::Release ${{ github.event.inputs.release_filter }} not found"
              exit 1
            fi
          else
            # Find all release directories
            releases=$(find cve-management/releases -maxdepth 1 -type d -name "nch-*" | sed 's|cve-management/releases/||' | jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "releases=$releases" >> $GITHUB_OUTPUT
          echo "Found releases: $releases"

  cve-scan:
    runs-on: ubuntu-latest
    needs: discover-releases
    if: needs.discover-releases.outputs.releases != '[]'
    strategy:
      matrix:
        release: ${{ fromJson(needs.discover-releases.outputs.releases) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # The username can still be the github.actor
          username: ${{ github.actor }}
          # Use the organization-level secret for the password
          password: ${{ secrets.DEPLOYMENT_PAT }}
          
      - name: Install Grype
        run: |
          echo "Installing Grype vulnerability scanner..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version
          
      - name: Verify Docker authentication
        run: |
          echo "Verifying Docker authentication to ghcr.io..."
          echo "GitHub Actor: ${{ github.actor }}"
          echo "Release: ${{ matrix.release }}"
          
          # Test authentication
          echo "Testing GHCR access..."
          if docker manifest inspect ghcr.io/nirmata/users:latest > /dev/null 2>&1; then
            echo "✅ Authentication test successful"
          else
            echo "⚠️ Authentication test failed for latest tag, proceeding with release-specific images"
          fi
          
      - name: Read release images
        id: release-info
        run: |
          release_dir="cve-management/releases/${{ matrix.release }}"
          images_file="$release_dir/images.txt"
          
          if [ ! -f "$images_file" ]; then
            echo "::error::images.txt file not found for release ${{ matrix.release }}"
            exit 1
          fi
          
          # Count images
          image_count=$(wc -l < "$images_file")
          echo "image_count=$image_count" >> $GITHUB_OUTPUT
          echo "Found $image_count images to scan for release ${{ matrix.release }}"
          
          # Display images
          echo "Images to scan:"
          cat "$images_file"
          
      - name: Create scan results directory
        run: |
          mkdir -p cve-management/releases/${{ matrix.release }}/scan-results
          
      - name: Pull images and scan with Grype
        run: |
          release_dir="cve-management/releases/${{ matrix.release }}"
          images_file="$release_dir/images.txt"
          results_dir="$release_dir/scan-results"
          
          echo "Starting Grype vulnerability scan for release ${{ matrix.release }}"
          echo "========================================================"
          
          # Initialize consolidated scan report
          echo "# Vulnerability Scan Results for ${{ matrix.release }}" > "$results_dir/scan-grype.md"
          echo "" >> "$results_dir/scan-grype.md"
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$results_dir/scan-grype.md"
          echo "**Release:** ${{ matrix.release }}" >> "$results_dir/scan-grype.md"
          echo "**Scanner:** Grype vulnerability scanner" >> "$results_dir/scan-grype.md"
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$results_dir/scan-grype.md"
          echo "" >> "$results_dir/scan-grype.md"
          
          # Initialize consolidated JSON structure
          echo "{" > "$results_dir/scan-grype.json"
          echo "  \"scanInfo\": {" >> "$results_dir/scan-grype.json"
          echo "    \"scanDate\": \"$(date -u '+%Y-%m-%d %H:%M:%S UTC')\"," >> "$results_dir/scan-grype.json"
          echo "    \"release\": \"${{ matrix.release }}\"," >> "$results_dir/scan-grype.json"
          echo "    \"scanner\": \"Grype\"," >> "$results_dir/scan-grype.json"
          echo "    \"workflowRun\": \"${{ github.run_id }}\"" >> "$results_dir/scan-grype.json"
          echo "  }," >> "$results_dir/scan-grype.json"
          echo "  \"images\": [" >> "$results_dir/scan-grype.json"
          
          overall_success=true
          image_count=0
          
          # Add markdown table header
          echo "| Image | Status | Vulnerabilities |" >> "$results_dir/scan-grype.md"
          echo "|-------|--------|----------------|" >> "$results_dir/scan-grype.md"
          
          # Process each image
          while IFS= read -r full_image; do
            # Skip empty lines and comments
            [[ -z "$full_image" || "$full_image" =~ ^[[:space:]]*# ]] && continue
            
            # Add comma for JSON array (except for first item)
            [ $image_count -gt 0 ] && echo "," >> "$results_dir/scan-grype.json"
            
            echo ""
            echo "Processing: $full_image"
            echo "----------------------------------------"
            
            # Check if image exists and is accessible
            echo "Checking image accessibility: $full_image"
            max_retries=3
            retry_count=0
            image_accessible=false
            
            while [ $retry_count -lt $max_retries ] && [ "$image_accessible" = false ]; do
              if docker manifest inspect "$full_image" >/dev/null 2>&1; then
                image_accessible=true
                echo "✅ Image $full_image is accessible"
              else
                retry_count=$((retry_count + 1))
                echo "⚠️ Image $full_image not accessible (attempt $retry_count/$max_retries)"
                [ $retry_count -lt $max_retries ] && sleep 2
              fi
            done
            
            if [ "$image_accessible" = true ]; then
              # Scan with Grype - Table and JSON formats  
              echo "Scanning with Grype (Table and JSON formats): $full_image"
              temp_table=$(mktemp)
              temp_json=$(mktemp)
              
              if grype "$full_image" --output table --file "$temp_table" && \
                 grype "$full_image" --output json --file "$temp_json"; then
                
                echo "✅ Successfully scanned: $full_image"
                
                # Count vulnerabilities from table output - count actual vulnerability lines
                if [ -f "$temp_table" ]; then
                  # Count lines that contain vulnerability IDs (CVE- or GHSA-)
                  vuln_count=$(grep -c -E "(CVE-|GHSA-)" "$temp_table" 2>/dev/null || echo "0")
                else
                  vuln_count=0
                fi
                
                # Parse vulnerability table and create JSON structure
                vuln_json_temp=$(mktemp)
                echo "        \"vulnerabilities\": [" > "$vuln_json_temp"
                
                if [ -f "$temp_table" ] && [ "$vuln_count" -gt 0 ]; then
                  # Parse vulnerability data from table (skip header lines) - avoid subshell issues
                  first_vuln=true
                  
                  # Read table into array to avoid subshell
                  readarray -t table_lines < <(tail -n +4 "$temp_table")
                  
                  for line in "${table_lines[@]}"; do
                    # Skip empty lines
                    [[ -z "$line" || "$line" =~ ^[[:space:]]*$ ]] && continue
                    
                    # Parse fixed-width table columns based on header positions
                    # Format: NAME INSTALLED FIXED_IN TYPE VULNERABILITY SEVERITY EPSS RISK
                    # Use substr to extract fields at specific positions to handle empty FIXED_IN
                    read -r name installed fixed_in type vulnerability severity epss risk <<< "$(echo "$line" | awk '
                      {
                        # Fixed-width parsing based on actual table layout
                        name = substr($0, 1, 22)
                        installed = substr($0, 23, 12)
                        fixed_in = substr($0, 35, 10)
                        type = substr($0, 45, 14)
                        vulnerability = substr($0, 59, 21)
                        severity = substr($0, 80, 10)
                        epss = substr($0, 90, 15)
                        risk = substr($0, 105)
                        
                        # Clean up fields (remove leading/trailing spaces)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", name)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", installed)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", fixed_in)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", type)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", vulnerability)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", severity)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", epss)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", risk)
                        
                        print name, installed, fixed_in, type, vulnerability, severity, epss, risk
                      }')"
                    
                    # Skip if essential fields are empty
                    [ -z "$name" ] || [ -z "$vulnerability" ] && continue
                    
                    # DEBUG: Print parsed fields to see what's happening
                    echo "DEBUG: Parsed fields for line: $line"
                    echo "DEBUG: name=[$name] installed=[$installed] fixed_in=[$fixed_in] type=[$type] vulnerability=[$vulnerability] severity=[$severity]"
                    
                    # Extract published date from JSON output
                    published_date=""
                    if [ -f "$temp_json" ]; then
                      # Search for the vulnerability in JSON and extract published date
                      published_date=$(jq -r --arg vuln_id "$vulnerability" '
                        .matches[] | 
                        select(.vulnerability.id == $vuln_id) | 
                        .vulnerability.publishedDate // ""
                      ' "$temp_json" 2>/dev/null | head -1)
                      
                      # If not found, try alternative field names
                      if [ -z "$published_date" ] || [ "$published_date" = "null" ]; then
                        published_date=$(jq -r --arg vuln_id "$vulnerability" '
                          .matches[] | 
                          select(.vulnerability.id == $vuln_id) | 
                          (.vulnerability.dataSource.publishedDate // .vulnerability.published // "")
                        ' "$temp_json" 2>/dev/null | head -1)
                      fi
                      
                      # Clean up the date
                      [ "$published_date" = "null" ] && published_date=""
                    fi
                    
                    # Add comma for previous entry (except first)
                    if [ "$first_vuln" = false ]; then
                      echo "," >> "$vuln_json_temp"
                    fi
                    first_vuln=false
                    
                    # Add vulnerability entry
                    echo "          {" >> "$vuln_json_temp"
                    echo "            \"name\": \"$name\"," >> "$vuln_json_temp"
                    echo "            \"installed\": \"$installed\"," >> "$vuln_json_temp"
                    echo "            \"fixed_in\": \"$fixed_in\"," >> "$vuln_json_temp"
                    echo "            \"type\": \"$type\"," >> "$vuln_json_temp"
                    echo "            \"vulnerability\": \"$vulnerability\"," >> "$vuln_json_temp"
                    echo "            \"severity\": \"$severity\"," >> "$vuln_json_temp"
                    echo "            \"epss\": \"$epss\"," >> "$vuln_json_temp"
                    echo "            \"risk\": \"$risk\"," >> "$vuln_json_temp"
                    echo "            \"published_date\": \"$published_date\"" >> "$vuln_json_temp"
                    echo "          }" >> "$vuln_json_temp"
                  done
                fi
                
                echo "        ]" >> "$vuln_json_temp"
                
                # Add to consolidated JSON (add image entry)
                echo "    {" >> "$results_dir/scan-grype.json"
                echo "      \"image\": \"$full_image\"," >> "$results_dir/scan-grype.json"
                echo "      \"status\": \"success\"," >> "$results_dir/scan-grype.json"
                echo "      \"vulnerabilityCount\": $vuln_count," >> "$results_dir/scan-grype.json"
                echo "      \"scan\": {" >> "$results_dir/scan-grype.json"
                cat "$vuln_json_temp" >> "$results_dir/scan-grype.json"
                echo "      }" >> "$results_dir/scan-grype.json"
                echo "    }" >> "$results_dir/scan-grype.json"
                
                # Cleanup temp files
                rm -f "$vuln_json_temp"
                
                # Add to consolidated Markdown
                echo "" >> "$results_dir/scan-grype.md"
                echo "## $full_image" >> "$results_dir/scan-grype.md"
                echo "" >> "$results_dir/scan-grype.md"
                echo "**Vulnerabilities Found:** $vuln_count" >> "$results_dir/scan-grype.md"
                echo "" >> "$results_dir/scan-grype.md"
                
                # Add vulnerability table if available
                if [ -f "$temp_table" ] && [ -s "$temp_table" ]; then
                  echo "### Vulnerability Details" >> "$results_dir/scan-grype.md"
                  echo "" >> "$results_dir/scan-grype.md"
                  
                  # Create custom table with desired columns (remove EPSS/RISK, add published date)
                  echo "| NAME | INSTALLED | FIXED IN | TYPE | VULNERABILITY | SEVERITY | PUBLISHED DATE |" >> "$results_dir/scan-grype.md"
                  echo "|------|-----------|----------|------|---------------|----------|----------------|" >> "$results_dir/scan-grype.md"
                  
                  # Process each vulnerability line and extract published dates
                  readarray -t vuln_lines < <(tail -n +4 "$temp_table")
                  
                  for vuln_line in "${vuln_lines[@]}"; do
                    # Skip empty lines
                    [[ -z "$vuln_line" || "$vuln_line" =~ ^[[:space:]]*$ ]] && continue
                    
                    # Parse fields using same logic as JSON generation
                    read -r name installed fixed_in type vulnerability severity epss risk <<< "$(echo "$vuln_line" | awk '
                      {
                        name = substr($0, 1, 22)
                        installed = substr($0, 23, 12)
                        fixed_in = substr($0, 35, 10)
                        type = substr($0, 45, 14)
                        vulnerability = substr($0, 59, 21)
                        severity = substr($0, 80, 10)
                        
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", name)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", installed)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", fixed_in)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", type)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", vulnerability)
                        gsub(/^[[:space:]]+|[[:space:]]+$/, "", severity)
                        
                        print name, installed, fixed_in, type, vulnerability, severity
                      }')"
                    
                    # Skip if essential fields are empty
                    [ -z "$name" ] || [ -z "$vulnerability" ] && continue
                    
                    # Extract published date from JSON output
                    published_date=""
                    if [ -f "$temp_json" ]; then
                      published_date=$(jq -r --arg vuln_id "$vulnerability" '
                        .matches[] | 
                        select(.vulnerability.id == $vuln_id) | 
                        .vulnerability.publishedDate // ""
                      ' "$temp_json" 2>/dev/null | head -1)
                      
                      if [ -z "$published_date" ] || [ "$published_date" = "null" ]; then
                        published_date=$(jq -r --arg vuln_id "$vulnerability" '
                          .matches[] | 
                          select(.vulnerability.id == $vuln_id) | 
                          (.vulnerability.dataSource.publishedDate // .vulnerability.published // "")
                        ' "$temp_json" 2>/dev/null | head -1)
                      fi
                      
                      [ "$published_date" = "null" ] && published_date=""
                      [ -z "$published_date" ] && published_date="N/A"
                    else
                      published_date="N/A"
                    fi
                    
                    # Add row to markdown table
                    echo "| $name | $installed | $fixed_in | $type | $vulnerability | $severity | $published_date |" >> "$results_dir/scan-grype.md"
                  done
                  
                  echo "" >> "$results_dir/scan-grype.md"
                fi
                
                # Add to summary table
                vuln_display="$vuln_count vulnerabilities"
                [ "$vuln_count" = "0" ] && vuln_display="✅ No vulnerabilities"
                
                echo "| \`$full_image\` | ✅ Success | $vuln_display |" >> "$results_dir/scan-grype.md"
                
                # Cleanup temp files
                rm -f "$temp_table" "$temp_json"
                
              else
                echo "❌ Failed to scan: $full_image"
                
                # Add failed entry to JSON
                echo "    {" >> "$results_dir/scan-grype.json"
                echo "      \"image\": \"$full_image\"," >> "$results_dir/scan-grype.json"
                echo "      \"status\": \"scan_failed\"," >> "$results_dir/scan-grype.json"
                echo "      \"vulnerabilityCount\": null," >> "$results_dir/scan-grype.json"
                echo "      \"scan\": null" >> "$results_dir/scan-grype.json"
                echo "    }" >> "$results_dir/scan-grype.json"
                
                echo "| \`$full_image\` | ❌ Scan Failed | Error during scan |" >> "$results_dir/scan-grype.md"
                overall_success=false
                rm -f "$temp_table" "$temp_json"
              fi
              
            else
              echo "❌ Cannot access image: $full_image"
              
              # Add failed entry to JSON
              echo "    {" >> "$results_dir/scan-grype.json"
              echo "      \"image\": \"$full_image\"," >> "$results_dir/scan-grype.json"
              echo "      \"status\": \"access_failed\"," >> "$results_dir/scan-grype.json"
              echo "      \"vulnerabilityCount\": null," >> "$results_dir/scan-grype.json"
              echo "      \"scan\": null" >> "$results_dir/scan-grype.json"
              echo "    }" >> "$results_dir/scan-grype.json"
              
              echo "| \`$full_image\` | ❌ Access Failed | Image not accessible |" >> "$results_dir/scan-grype.md"
              overall_success=false
            fi
            
            image_count=$((image_count + 1))
            
          done < "$images_file"
          
          # Close JSON structure
          echo "" >> "$results_dir/scan-grype.json"
          echo "  ]" >> "$results_dir/scan-grype.json"
          echo "}" >> "$results_dir/scan-grype.json"
          
          echo ""
          echo "========================================================"
          echo "Grype vulnerability scan completed for release ${{ matrix.release }}"
          
          # Add scan metadata to consolidated report
          echo "" >> "$results_dir/scan-grype.md"
          echo "## Scan Information" >> "$results_dir/scan-grype.md"
          echo "- **Total Images**: $image_count" >> "$results_dir/scan-grype.md"
          echo "- **Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$results_dir/scan-grype.md"
          echo "- **Workflow**: ${{ github.workflow }}" >> "$results_dir/scan-grype.md"
          echo "- **Run ID**: ${{ github.run_id }}" >> "$results_dir/scan-grype.md"
          echo "- **Overall Status**: $([ "$overall_success" = true ] && echo "✅ All images processed successfully" || echo "⚠️ Some images had issues")" >> "$results_dir/scan-grype.md"
          
          # Output the summary
          echo ""
          echo "Consolidated scan results for ${{ matrix.release }}:"
          echo "- JSON: $results_dir/scan-grype.json"
          echo "- Markdown: $results_dir/scan-grype.md"
          
      - name: Commit scan results to release folder
        run: |
          release_dir="cve-management/releases/${{ matrix.release }}"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Check if consolidated files exist and have content
          if [ -f "$release_dir/scan-results/scan-grype.json" ] && [ -f "$release_dir/scan-results/scan-grype.md" ]; then
            echo "Consolidated scan result files generated, proceeding with commit"
            # Add and commit the scan results
            git add "$release_dir/scan-results/"
            git commit -m "Update vulnerability scan results for ${{ matrix.release }} - Grype consolidated scan: $(date -u '+%Y-%m-%d %H:%M:%S UTC') - Run: ${{ github.run_id }}"
            
            echo "✅ Committed consolidated scan results for ${{ matrix.release }}"
          else
            echo "❌ Consolidated scan result files not found, skipping commit"
            echo "Expected files:"
            echo "  - $release_dir/scan-results/scan-grype.json"
            echo "  - $release_dir/scan-results/scan-grype.md"
            ls -la "$release_dir/scan-results/" || echo "Scan results directory not found"
          fi
          
      - name: Push scan results to repository
        run: |
          # Check if there are any commits to push
          if git log --oneline origin/main..HEAD | grep -q "Update vulnerability scan results"; then
            echo "Pushing scan results to repository..."
            
            # Retry push with pull/rebase in case of concurrent pushes
            max_retries=5
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "✅ Successfully pushed scan results for ${{ matrix.release }} (attempt $((retry_count + 1)))"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "⚠️ Push failed, attempting to pull and rebase (attempt $retry_count/$max_retries)..."
                  
                  # Pull with rebase to integrate remote changes
                  if git pull --rebase origin main; then
                    echo "✅ Successfully rebased with remote changes"
                    # Add a small random delay to reduce race conditions
                    sleep $((RANDOM % 10 + 1))
                  else
                    echo "❌ Failed to rebase with remote changes"
                    break
                  fi
                else
                  echo "❌ Failed to push after $max_retries attempts for ${{ matrix.release }}"
                  echo "This is likely due to concurrent job conflicts, but scan results are still generated as artifacts"
                  exit 1
                fi
              fi
            done
          else
            echo "No CVE scan result commits to push"
          fi
          
      - name: Upload scan results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-scan-${{ matrix.release }}
          path: cve-management/releases/${{ matrix.release }}/scan-results/
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: [discover-releases, cve-scan]
    if: always() && needs.discover-releases.outputs.releases != '[]'
    steps:
      - name: Download all scan results
        uses: actions/download-artifact@v4
        with:
          path: all-scan-results/
          pattern: vulnerability-scan-*
          
      - name: Generate overall summary
        run: |
          echo "# Overall Vulnerability Scan Summary" > overall-summary.md
          echo "" >> overall-summary.md
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> overall-summary.md
          echo "**Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> overall-summary.md
          echo "" >> overall-summary.md
          
          # Find all consolidated markdown files
          find all-scan-results -name "scan-grype.md" | while read -r scan_file; do
            release_name=$(echo "$scan_file" | sed 's|all-scan-results/vulnerability-scan-||' | sed 's|/scan-grype.md||')
            echo "## Release: $release_name" >> overall-summary.md
            echo "" >> overall-summary.md
            # Skip the first line (title) of each summary
            tail -n +2 "$scan_file" >> overall-summary.md
            echo "" >> overall-summary.md
          done
          
          echo "Generated overall summary:"
          cat overall-summary.md
          
      - name: Upload overall summary
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-summary
          path: overall-summary.md
          retention-days: 30
