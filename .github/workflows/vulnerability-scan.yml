name: Vulnerability Scan

on:
  schedule:
    # Run at 1:00 AM PST (9:00 AM UTC during standard time, 8:00 AM UTC during daylight time)
    # Using 9:00 AM UTC to cover PST standard time
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      release_filter:
        description: 'Specific release to scan (e.g., nch-4.22). Leave empty to scan all releases.'
        required: false
        type: string
      
jobs:
  discover-releases:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ steps.find-releases.outputs.releases }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Find release directories
        id: find-releases
        run: |
          if [ -n "${{ github.event.inputs.release_filter }}" ]; then
            # If a specific release is requested, only scan that one
            if [ -d "releases/${{ github.event.inputs.release_filter }}" ]; then
              releases='["${{ github.event.inputs.release_filter }}"]'
            else
              echo "::error::Release ${{ github.event.inputs.release_filter }} not found"
              exit 1
            fi
          else
            # Find all release directories
            releases=$(find releases -maxdepth 1 -type d -name "nch-*" | sed 's|releases/||' | jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "releases=$releases" >> $GITHUB_OUTPUT
          echo "Found releases: $releases"

  vulnerability-scan:
    runs-on: ubuntu-latest
    needs: discover-releases
    if: needs.discover-releases.outputs.releases != '[]'
    strategy:
      matrix:
        release: ${{ fromJson(needs.discover-releases.outputs.releases) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version
          
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Read release information
        id: release-info
        run: |
          release_dir="releases/${{ matrix.release }}"
          
          if [ ! -f "$release_dir/current-tag" ]; then
            echo "::error::current-tag file not found for release ${{ matrix.release }}"
            exit 1
          fi
          
          if [ ! -f "$release_dir/images" ]; then
            echo "::error::images file not found for release ${{ matrix.release }}"
            exit 1
          fi
          
          tag=$(cat "$release_dir/current-tag")
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Release ${{ matrix.release }} tag: $tag"
          
          # Count images for matrix info
          image_count=$(wc -l < "$release_dir/images")
          echo "image_count=$image_count" >> $GITHUB_OUTPUT
          echo "Found $image_count images to scan"
          
      - name: Create scan results directory
        run: |
          mkdir -p scan-results/${{ matrix.release }}
          
      - name: Scan images with Grype
        run: |
          release_dir="releases/${{ matrix.release }}"
          tag="${{ steps.release-info.outputs.tag }}"
          results_dir="scan-results/${{ matrix.release }}"
          
          echo "Starting vulnerability scan for release ${{ matrix.release }} (tag: $tag)"
          echo "========================================================"
          
          # Initialize summary files
          echo "# Vulnerability Scan Results for ${{ matrix.release }} (${tag})" > "$results_dir/summary.md"
          echo "" >> "$results_dir/summary.md"
          echo "| Image | Critical | High | Medium | Low | Report |" >> "$results_dir/summary.md"
          echo "|-------|----------|------|--------|-----|--------|" >> "$results_dir/summary.md"
          
          overall_exit_code=0
          
          # Read and scan each image
          while IFS= read -r image_base; do
            # Skip empty lines and comments
            [[ -z "$image_base" || "$image_base" =~ ^[[:space:]]*# ]] && continue
            
            # Construct full image name with tag
            full_image="${image_base}:${tag}"
            
            # Sanitize image name for filename (replace / and : with -)
            safe_name=$(echo "$image_base" | sed 's|[/:]|-|g')
            
            echo ""
            echo "Scanning: $full_image"
            echo "----------------------------------------"
            
            # Run Grype scan
            if grype "$full_image" \
              --output json \
              --file "$results_dir/${safe_name}.json" \
              --output table \
              --file "$results_dir/${safe_name}.txt"; then
              
              echo "✅ Successfully scanned: $full_image"
              
              # Extract vulnerability counts from JSON for summary
              if [ -f "$results_dir/${safe_name}.json" ]; then
                critical=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' "$results_dir/${safe_name}.json" 2>/dev/null || echo "0")
                high=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' "$results_dir/${safe_name}.json" 2>/dev/null || echo "0")
                medium=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' "$results_dir/${safe_name}.json" 2>/dev/null || echo "0")
                low=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' "$results_dir/${safe_name}.json" 2>/dev/null || echo "0")
                
                # Add to summary table
                echo "| \`$image_base\` | $critical | $high | $medium | $low | [JSON](./${safe_name}.json) / [TXT](./${safe_name}.txt) |" >> "$results_dir/summary.md"
                
                # Set exit code to 1 if critical or high vulnerabilities found
                if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
                  overall_exit_code=1
                  echo "⚠️  High or critical vulnerabilities found in $full_image"
                fi
              else
                echo "| \`$image_base\` | ERROR | ERROR | ERROR | ERROR | Scan failed |" >> "$results_dir/summary.md"
                overall_exit_code=1
              fi
            else
              echo "❌ Failed to scan: $full_image"
              echo "| \`$image_base\` | ERROR | ERROR | ERROR | ERROR | Scan failed |" >> "$results_dir/summary.md"
              overall_exit_code=1
            fi
            
          done < "$release_dir/images"
          
          echo ""
          echo "========================================================"
          echo "Scan completed for release ${{ matrix.release }}"
          
          # Add scan metadata to summary
          echo "" >> "$results_dir/summary.md"
          echo "## Scan Information" >> "$results_dir/summary.md"
          echo "- **Release**: ${{ matrix.release }}" >> "$results_dir/summary.md"
          echo "- **Tag**: ${tag}" >> "$results_dir/summary.md"
          echo "- **Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$results_dir/summary.md"
          echo "- **Grype Version**: $(grype version 2>/dev/null | head -n1 || echo 'Unknown')" >> "$results_dir/summary.md"
          echo "- **Workflow**: ${{ github.workflow }}" >> "$results_dir/summary.md"
          echo "- **Run ID**: ${{ github.run_id }}" >> "$results_dir/summary.md"
          
          # Output the summary
          echo ""
          echo "Summary for ${{ matrix.release }}:"
          cat "$results_dir/summary.md"
          
          # Set job output for later steps
          echo "exit_code=$overall_exit_code" >> $GITHUB_OUTPUT
          
        id: scan
        
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-scan-${{ matrix.release }}
          path: scan-results/${{ matrix.release }}/
          retention-days: 30
          
      - name: Check for critical vulnerabilities
        if: steps.scan.outputs.exit_code == '1'
        run: |
          echo "::warning::Critical or high severity vulnerabilities found in release ${{ matrix.release }}"
          echo "Please review the scan results and take appropriate action."
          # Don't fail the job, just warn - you can change this behavior if needed
          # exit 1

  summary:
    runs-on: ubuntu-latest
    needs: [discover-releases, vulnerability-scan]
    if: always() && needs.discover-releases.outputs.releases != '[]'
    steps:
      - name: Download all scan results
        uses: actions/download-artifact@v4
        with:
          path: all-scan-results/
          pattern: vulnerability-scan-*
          
      - name: Generate overall summary
        run: |
          echo "# Overall Vulnerability Scan Summary" > overall-summary.md
          echo "" >> overall-summary.md
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> overall-summary.md
          echo "**Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> overall-summary.md
          echo "" >> overall-summary.md
          
          # Find all summary files
          find all-scan-results -name "summary.md" | while read -r summary_file; do
            release_name=$(echo "$summary_file" | sed 's|all-scan-results/vulnerability-scan-||' | sed 's|/summary.md||')
            echo "## Release: $release_name" >> overall-summary.md
            echo "" >> overall-summary.md
            # Skip the first line (title) of each summary
            tail -n +2 "$summary_file" >> overall-summary.md
            echo "" >> overall-summary.md
          done
          
          echo "Generated overall summary:"
          cat overall-summary.md
          
      - name: Upload overall summary
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-summary
          path: overall-summary.md
          retention-days: 30
